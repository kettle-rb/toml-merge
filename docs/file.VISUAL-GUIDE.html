<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: VISUAL-GUIDE
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "VISUAL-GUIDE";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: VISUAL-GUIDE</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="visual-guide-toml-merge--tree_haver-v2--toml-rb">Visual Guide: toml-merge + tree_haver v2 + toml-rb</h1>

<h2 id="the-complete-flow">The Complete Flow</h2>

<pre class="code ruby"><code class="ruby">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  toml-merge Application                          ┃
┃  ┌──────────────────────────────────────────┐    ┃
┃  │ lib/toml/merge/file_analysis.rb          │    ┃
┃  │                                           │    ┃
┃  │  parser = TreeHaver::Parser.new          │    ┃
┃  │  parser.language = TreeHaver::Language.toml    ┃
┃  │  @ast = parser.parse(@source)            │    ┃
┃  │  @ast.root_node.each { |node| ... }      │    ┃
┃  │                                           │    ┃
┃  │  ← Same code for ALL backends! →         │    ┃
┃  └──────────────────────────────────────────┘    ┃
┗━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                        ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  tree_haver v2 (Backend Framework)               ┃
┃  ┌──────────────────────────────────────────┐    ┃
┃  │ TreeHaver::Parser                        │    ┃
┃  │ TreeHaver::Tree   (unified wrapper)      │    ┃
┃  │ TreeHaver::Node   (unified wrapper)      │    ┃
┃  │ TreeHaver::Point  (unified wrapper)      │    ┃
┃  │                                           │    ┃
┃  │ def backend_module                       │    ┃
┃  │   # Auto-select best available backend   │    ┃
┃  │   if tree-sitter available?              │    ┃
┃  │     return TreeSitter backend            │    ┃
┃  │   elsif citrus available?                │    ┃
┃  │     return Citrus backend                │    ┃
┃  │   end                                     │    ┃
┃  └──────────────────────────────────────────┘    ┃
┗━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┛
                    ↓           ↓
      ┏━━━━━━━━━━━━━┛           ┗━━━━━━━━━━━━━━━┓
      ↓                                         ↓
┏━━━━━━━━━━━━━━━━━━━━━┓           ┏━━━━━━━━━━━━━━━━━━━━━┓
┃ tree-sitter Backends┃           ┃ Citrus Backend      ┃
┃ ┌─────────────────┐ ┃           ┃ ┌─────────────────┐ ┃
┃ │ Backends::MRI   │ ┃           ┃ │Backends::Citrus │ ┃
┃ │   (C extension) │ ┃           ┃ │  (pure Ruby)    │ ┃
┃ │                 │ ┃           ┃ │                 │ ┃
┃ │ Backends::Rust  │ ┃           ┃ │ def parse(src)  │ ┃
┃ │   (tree_stump)  │ ┃           ┃ │   match =       │ ┃
┃ │                 │ ┃           ┃ │   @grammar.parse│ ┃
┃ │ Backends::FFI   │ ┃           ┃ │   wrap(match)   │ ┃
┃ │   (JRuby)       │ ┃           ┃ │ end             │ ┃
┃ │                 │ ┃           ┃ └─────────────────┘ ┃
┃ │ Backends::Java  │ ┃           ┃          ↓          ┃
┃ │   (JRuby)       │ ┃           ┃ @grammar is what?   ┃
┃ └─────────────────┘ ┃           ┗━━━━━━━━━┳━━━━━━━━━━━┛
┃         ↓           ┃                     ↓
┃ ┌─────────────────┐ ┃           ┏━━━━━━━━━━━━━━━━━━━━━┓
┃ │Native Libraries │ ┃           ┃ toml-rb             ┃
┃ │                 │ ┃           ┃ ┌─────────────────┐ ┃
┃ │ libtree-sitter  │ ┃           ┃ │TomlRB::Document │ ┃
┃ │ .so/.dylib      │ ┃           ┃ │                 │ ┃
┃ │                 │ ┃           ┃ │ Citrus grammar  │ ┃
┃ │ libtree-sitter- │ ┃           ┃ │ for TOML syntax │ ┃
┃ │ toml.so         │ ┃           ┃ │                 │ ┃
┃ │                 │ ┃           ┃ │ .parse() method │ ┃
┃ └─────────────────┘ ┃           ┃ │ returns Citrus  │ ┃
┃                     ┃           ┃ │ ::Match tree    │ ┃
┗━━━━━━━━━━━━━━━━━━━━━┛           ┃ └─────────────────┘ ┃
                                  ┗━━━━━━━━━━━━━━━━━━━━━┛
</code></pre>

<h2 id="backend-selection-flow">Backend Selection Flow</h2>

<pre class="code ruby"><code class="ruby">User runs: toml-merge
    ↓
tree_haver checks: ruby_tree_sitter available?
    ↓ YES → Use MRI backend (fast) ✅
    ↓ NO → Continue...
    ↓
tree_haver checks: tree_stump (Rust) available?
    ↓ YES → Use Rust backend (fast) ✅
    ↓ NO → Continue...
    ↓
tree_haver checks: FFI + libtree-sitter available?
    ↓ YES → Use FFI backend (fast) ✅
    ↓ NO → Continue...
    ↓
tree_haver checks: citrus + toml-rb available?
    ↓ YES → Use Citrus backend (pure Ruby) ✅
    ↓ NO → Error (no backend available)
</code></pre>

<h2 id="what-toml-rb-provides">What toml-rb Provides</h2>

<pre class="code language-ruby"><code class="language-ruby"># toml-rb gem structure
module TomlRB
  module Document  # ← This is the Citrus grammar
    extend Citrus::Grammar
    
    # Grammar rules defined in Citrus PEG syntax
    # Defines: document, table, array_of_tables, pair, etc.
    
    def self.parse(source)
      # Returns Citrus::Match (parse tree)
    end
  end
  
  # Semantic classes (not used by tree_haver directly)
  class Table
  class TableArray
  class Keyvalue
end

# tree_haver uses it like this:
grammar = TomlRB::Document
match = grammar.parse(toml_source)  # Get parse tree
# Wrap in TreeHaver::Node for unified API
</code></pre>

<h2 id="comparison-table">Comparison Table</h2>

<table>
  <thead>
    <tr>
      <th>Aspect</th>
      <th>tree-sitter Backends</th>
      <th>Citrus Backend (toml-rb)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Speed</strong></td>
      <td>Fast (native C/Rust)</td>
      <td>Slower (pure Ruby)</td>
    </tr>
    <tr>
      <td><strong>Installation</strong></td>
      <td>Requires native libs</td>
      <td>No native deps</td>
    </tr>
    <tr>
      <td><strong>Platforms</strong></td>
      <td>Limited (needs compilation)</td>
      <td>Universal (pure Ruby)</td>
    </tr>
    <tr>
      <td><strong>Grammar Source</strong></td>
      <td>libtree-sitter-toml.so</td>
      <td>TomlRB::Document module</td>
    </tr>
    <tr>
      <td><strong>API</strong></td>
      <td>TreeHaver::Node</td>
      <td>TreeHaver::Node (same!)</td>
    </tr>
    <tr>
      <td><strong>Used When</strong></td>
      <td>Preferred (fast)</td>
      <td>Fallback (portable)</td>
    </tr>
  </tbody>
</table>

<h2 id="code-path-comparison">Code Path Comparison</h2>

<h3 id="path-1-tree-sitter-backend">Path 1: tree-sitter Backend</h3>

<pre class="code language-ruby"><code class="language-ruby"># toml-merge code
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Language.toml
tree = parser.parse(source)

# Inside tree_haver (MRI backend)
language = load_library(&quot;/usr/lib/libtree-sitter-toml.so&quot;)
ts_tree = TreeSitter.parse(source, language)
TreeHaver::Tree.new(ts_tree, source: source)

# Result
tree.root_node  # TreeHaver::Node wrapping TreeSitter::Node
</code></pre>

<h3 id="path-2-citrus-backend-toml-rb">Path 2: Citrus Backend (toml-rb)</h3>

<pre class="code language-ruby"><code class="language-ruby"># toml-merge code (SAME AS ABOVE!)
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Language.toml
tree = parser.parse(source)

# Inside tree_haver (Citrus backend)
grammar = TomlRB::Document
citrus_match = grammar.parse(source)
citrus_tree = Citrus::Tree.new(citrus_match, source)
TreeHaver::Tree.new(citrus_tree, source: source)

# Result
tree.root_node  # TreeHaver::Node wrapping Citrus::Match
</code></pre>

<p><strong>Notice</strong>: toml-merge code is IDENTICAL! tree_haver handles the difference.</p>

<h2 id="dependency-chain">Dependency Chain</h2>

<pre class="code ruby"><code class="ruby">toml-merge.gemspec:
  spec.add_dependency(&quot;tree_haver&quot;, &quot;~&gt; 2.0&quot;)
  spec.add_dependency(&quot;toml-rb&quot;, &quot;~&gt; 4.1&quot;)
      ↓
tree_haver.gemspec:
  spec.add_dependency(&quot;citrus&quot;, &quot;~&gt; 3.0&quot;)  # Citrus parser generator
      ↓
toml-rb.gemspec:
  spec.add_dependency(&quot;citrus&quot;, &quot;~&gt; 3.0&quot;)  # Uses Citrus for grammar
</code></pre>

<p><strong>Result</strong>:</p>
<ul>
  <li>citrus gets installed (needed by both tree_haver and toml-rb)</li>
  <li>toml-rb gets installed (TOML grammar for Citrus)</li>
  <li>tree_haver can use Citrus backend with toml-rb grammar</li>
  <li>100% installation success guaranteed!</li>
</ul>

<h2 id="the-genius-of-this-design">The Genius of This Design</h2>

<ol>
  <li>
<strong>Separation of Concerns</strong>
    <ul>
      <li>tree_haver = backend framework</li>
      <li>toml-rb = TOML grammar</li>
      <li>toml-merge = merge logic</li>
    </ul>
  </li>
  <li>
<strong>Reusability</strong>
    <ul>
      <li>tree_haver’s Citrus backend works for ANY language</li>
      <li>Just need a Citrus grammar (toml-rb, json-rb, etc.)</li>
      <li>All *-merge gems benefit</li>
    </ul>
  </li>
  <li>
<strong>Flexibility</strong>
    <ul>
      <li>Fast when possible (tree-sitter)</li>
      <li>Works everywhere (Citrus)</li>
      <li>User doesn’t care - it just works</li>
    </ul>
  </li>
  <li>
<strong>Simplicity</strong>
    <ul>
      <li>toml-merge doesn’t know about backends</li>
      <li>tree_haver handles complexity</li>
      <li>Clean, maintainable code</li>
    </ul>
  </li>
</ol>

<h2 id="summary">Summary</h2>

<p><strong>toml-rb’s role</strong>: Provides the TOML grammar (TomlRB::Document) that tree_haver’s Citrus backend uses for pure Ruby parsing when tree-sitter libraries aren’t available.</p>

<p><strong>Why it’s brilliant</strong>: Instead of implementing dual backends in every *-merge gem, the backend framework (tree_haver) handles it once, and language-specific grammars (toml-rb) plug in as needed.</p>
</div></div>

      <div id="footer">
  Generated on Thu Feb 19 06:39:57 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.1).
</div>

    </div>
  </body>
</html>